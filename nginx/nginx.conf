events {

}


http {
    log_format upstream_time '$remote_addr - $remote_user [$time_local] '
                                 '"$request" $status $body_bytes_sent '
                                 '"$http_referer" "$http_user_agent"'
                                 'rt=$request_time uct="$upstream_connect_time" uht="$upstream_header_time" urt="$upstream_response_time"';

    error_log /etc/nginx/error_log.log warn;
    client_max_body_size 20m;

    proxy_cache_path /etc/nginx/cache keys_zone=one:500m max_size=1000m;

    upstream user-service {
        server user-service:9002;
    }

    upstream auth-service {
        server auth-service:9001;
    }

    server {
        listen 80;
        listen 443;
        server_name www.voltjunkie.ru voltjunkie.ru localhost;
        access_log stdout upstream_time;

        location / {
            try_files $uri @proxy ;
        }

        location @proxy {
            if ($request_uri ~* "^\/api\/users(.*)$") {
                set $url "http://user-service$1";
            }

            if ($request_uri ~* "^\/api\/auth(.*)$") {
                set $url "http://auth-service$1";
            }

            proxy_pass "$url";
        }



    }
}